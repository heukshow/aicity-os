<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Cauchemar Crew</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #050505;
            color: #ffffff;
        }

        .neon-purple {
            color: #bf5af2;
            text-shadow: 0 0 10px rgba(191, 90, 242, 0.5);
        }

        .bg-glass {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        select option {
            background-color: #1a1a1a;
            color: white;
        }
    </style>
</head>

<body class="antialiased min-h-screen pb-20">

    <!-- Auth Guard -->
    <script>
        const user = JSON.parse(sessionStorage.getItem('crew_user'));
        if (!user) window.location.href = 'login.html';
    </script>

    <header class="py-6 border-b border-white/5 bg-black/50 backdrop-blur-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-xl font-black tracking-tighter uppercase">CAUCHEMAR CREW <span
                    class="neon-purple">DASHBOARD</span></h1>
            <div class="flex items-center gap-4">
                <a href="#" id="my-portfolio-link" target="_blank"
                    class="text-xs font-bold text-purple-400 hover:text-white transition uppercase border border-purple-500/30 px-3 py-1 rounded-full hover:bg-purple-500/20">View
                    Portfolio</a>
                <a href="edit_portfolio.html"
                    class="text-xs font-bold text-green-400 hover:text-white transition uppercase border border-green-500/30 px-3 py-1 rounded-full hover:bg-green-500/20">Edit
                    Portfolio</a>
                <span id="header-name" class="text-sm font-bold text-gray-400"></span>
                <button onclick="logout()"
                    class="text-xs text-gray-500 hover:text-white transition uppercase font-bold pl-4 border-l border-white/10">Logout</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-12 max-w-4xl">
        <form onsubmit="handleSave(event)" class="space-y-12">

            <!-- Basic Profile -->
            <section class="space-y-6">
                <div class="flex flex-col md:flex-row gap-10 items-start">
                    <!-- Profile Preview -->
                    <div
                        class="w-48 h-64 bg-white/5 rounded-3xl border border-white/10 overflow-hidden flex-shrink-0 relative group">
                        <img id="profile-preview" src="https://via.placeholder.com/512x1024?text=PREVIEW"
                            class="w-full h-full object-cover transition duration-500 group-hover:scale-110"
                            onerror="this.src='https://via.placeholder.com/512x1024?text=ERROR'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                        <div
                            class="absolute bottom-4 w-full text-center text-[10px] font-black uppercase tracking-widest text-white/40">
                            Avatar Preview</div>
                    </div>

                    <div class="flex-1 grid md:grid-cols-2 gap-6 w-full">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">Nickname (ë‹‰ë„¤ì„)</label>
                            <input type="text" id="name"
                                class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 focus:outline-none transition">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">Role / Specialty (ì§í•¨/ì „ê³µ)</label>
                            <input type="text" id="role"
                                class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 focus:outline-none transition">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase flex justify-between items-center">
                                ZEPETO ID
                                <div class="flex gap-2">
                                    <button type="button" onclick="refreshZepetoStats(event)"
                                        class="text-[10px] text-green-400 hover:underline font-bold">íŒ”ë¡œì›Œ ê°±ì‹ </button>
                                    <button type="button" onclick="showZepetoHelp()"
                                        class="text-[10px] text-purple-400 hover:underline">ID ì°¾ëŠ” ë²•?</button>
                                </div>
                            </label>
                            <input type="text" id="zepeto_id" placeholder="ì˜ˆ: oskyoo12"
                                oninput="updateProfilePreview(this.value)"
                                class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 focus:outline-none transition">
                            <div id="zepeto-status" class="text-[10px] mt-1 pl-1"></div>
                        </div>
                        <div class="md:col-span-2 space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">Description</label>
                            <textarea id="description" rows="3"
                                class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 focus:outline-none transition"></textarea>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Info -->
            <section
                class="bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20 rounded-2xl p-6">
                <p class="text-sm text-gray-300 leading-relaxed">
                    ğŸ’¡ <strong>í¬íŠ¸í´ë¦¬ì˜¤ ë° ê°€ê²© ê´€ë¦¬</strong>ëŠ” "Edit Portfolio" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë³„ë„ í˜ì´ì§€ì—ì„œ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </section>

            <!-- Save Action -->
            <div class="pt-12 border-t border-white/5">
                <button type="submit"
                    class="w-full bg-white text-black font-bold py-5 rounded-2xl text-lg hover:bg-gray-200 transition">
                    SAVE CHANGES
                </button>
            </div>

        </form>
    </main>

    <script>
        const categories = {
            "ì•„ì´í…œ ì œì‘": ["í—¤ì–´", "ìƒì˜", "í•œë²Œì˜ìƒ", "ì‹ ë°œ", "í—¤ë“œì›¨ì–´", "ê°€ë°©", "ê¸°íƒ€"],
            "ì›”ë“œ ì œì‘": ["ì í”„ë§µ", "êµ¬ê²½ë§µ", "ë“œë¼ë§ˆ/ìƒí™©ê·¹", "ê¸°íƒ€"],
            "ì´ë¯¸ì§€ ì œì‘": [],
            "ì˜ìƒ ì œì‘": [],
            "í™ë³´": []
        };

        document.getElementById('header-name').innerText = user.id; // Show ZEPETO ID in header
        document.getElementById('my-portfolio-link').href = `member.html?id=${user.id}`;
        document.getElementById('name').value = user.name;
        document.getElementById('role').value = user.role;
        document.getElementById('zepeto_id').value = user.zepeto_id || '';
        document.getElementById('description').value = user.description;

        function updateProfilePreview(val) {
            const preview = document.getElementById('profile-preview');
            const status = document.getElementById('zepeto-status');
            if (val) {
                let url = val;
                if (!val.startsWith('http')) {
                    url = `https://render-api.zepeto.io/v2/graphics/zepeto/character/${val}/image/2D?width=512`;
                }
                preview.src = url;
                status.innerHTML = `<a href="${url}" target="_blank" class="text-purple-400/60 hover:text-purple-400 transition">â†— ì§ì ‘ ë§í¬ë¡œ í™•ì¸í•˜ê¸° (ìºë¦­í„°ê°€ ì•ˆ ë‚˜ì˜¨ë‹¤ë©´ í´ë¦­)</a>`;
            } else {
                preview.src = 'https://via.placeholder.com/512x1024?text=EMPTY';
                status.innerHTML = '<span class="text-gray-600">ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>';
            }
        }
        updateProfilePreview(user.zepeto_id);

        function showZepetoHelp() {
            alert(`[ìºë¦­í„° ì´ë¯¸ì§€ê°€ ë‚˜ì˜¤ê²Œ í•˜ëŠ” ë°©ë²•]

í˜„ì¬ ì…ë ¥í•˜ì‹  'oskyoo12'ëŠ” ê²€ìƒ‰ìš© 'í•¸ë“¤(ì•„ì´ë””)'ì…ë‹ˆë‹¤. 
ë Œë”ë§ ì‹œìŠ¤í…œì€ ë³´ì•ˆìƒ 'ë‚´ ì½”ë“œ'ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1. ì œí˜í†  ì•± ì ‘ì† > ë‚´ í”„ë¡œí•„ > [í”„ë¡œí•„ í¸ì§‘] í´ë¦­
2. ë‹‰ë„¤ì„ ì•„ë˜ì— ìˆëŠ” [ë‚´ ì½”ë“œ] (ì˜ˆ: ABC123) í™•ì¸
3. í•´ë‹¹ '6ìë¦¬ ì½”ë“œ'ë¥¼ ZEPETO ID ì¹¸ì— ì…ë ¥í•´ ë³´ì„¸ìš”.

â€» ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ í”„ë¦¬ë·°ì— ëŒ€í‘œë‹˜ì˜ ìºë¦­í„°ê°€ ë°”ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤!`);
        }

        async function refreshZepetoStats(event) {
            const zepetoId = document.getElementById('zepeto_id').value;
            if (!zepetoId) {
                alert('ì œí˜í†  IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'ê°±ì‹  ì¤‘...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/crew/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('crew_token')}`
                    },
                    body: JSON.stringify({
                        id: user.id,
                        zepeto_id: zepetoId,
                        refresh_zepeto: true
                    })
                });

                const result = await response.json();
                if (result.status === 'ok') {
                    alert('ì œí˜í†  ì •ë³´(íŒ”ë¡œì›Œ í¬í•¨)ê°€ ì„±ê³µì ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                } else {
                    alert('ê°±ì‹  ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Error refreshing Zepeto stats:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function addPriceRow(mainCat = 'ì•„ì´í…œ ì œì‘', subCat = '', value = '') {
            const container = document.getElementById('price-container');
            const div = document.createElement('div');
            div.className = 'grid grid-cols-6 gap-4 items-center bg-white/5 p-4 rounded-2xl border border-white/5';

            const calcMarkup = (v) => {
                const num = parseInt(v.toString().replace(/,/g, '')) || 0;
                return Math.floor(num * 1.2).toLocaleString();
            };

            const mainOptions = Object.keys(categories).map(k => `<option value="${k}" ${mainCat === k ? 'selected' : ''}>${k}</option>`).join('');

            div.innerHTML = `
                <div class="col-span-2 space-y-1">
                    <label class="text-[10px] text-gray-500 font-bold uppercase">Category</label>
                    <select onchange="updateSubCats(this)" class="main-cat w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-sm">
                        ${mainOptions}
                    </select>
                </div>
                <div class="col-span-1 space-y-1 sub-cat-container ${categories[mainCat].length === 0 ? 'hidden' : ''}">
                    <label class="text-[10px] text-gray-500 font-bold uppercase">Sub-Category</label>
                    <select class="sub-cat w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-sm">
                        ${categories[mainCat].map(s => `<option value="${s}" ${subCat === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                </div>
                <div class="col-span-1 space-y-1">
                    <label class="text-[10px] text-gray-500 font-bold uppercase">Your Price (â‚©)</label>
                    <input type="text" placeholder="50,000" oninput="updatePreview(this)" class="w-full bg-white/10 border border-white/10 rounded-lg px-3 py-2 text-sm" value="${value}">
                </div>
                <div class="col-span-1 space-y-1">
                    <label class="text-[10px] text-purple-500 font-bold uppercase">Selling (+20%)</label>
                    <div class="preview-price text-purple-400 font-bold text-sm py-2">â‚©${calcMarkup(value)}</div>
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="text-gray-500 hover:text-red-500 transition">âœ–</button>
            `;
            container.appendChild(div);
        }

        function updateSubCats(select) {
            const mainCat = select.value;
            const subContainer = select.parentElement.parentElement.querySelector('.sub-cat-container');
            const subSelect = subContainer.querySelector('.sub-cat');

            const subs = categories[mainCat];
            if (subs.length > 0) {
                subContainer.classList.remove('hidden');
                subSelect.innerHTML = subs.map(s => `<option value="${s}">${s}</option>`).join('');
            } else {
                subContainer.classList.add('hidden');
                subSelect.innerHTML = '';
            }
        }

        function updatePreview(input) {
            const preview = input.parentElement.parentElement.querySelector('.preview-price');
            const num = parseInt(input.value.replace(/,/g, '')) || 0;
            preview.innerText = 'â‚©' + Math.floor(num * 1.2).toLocaleString();
        }

        // Initialize prices from legacy format or new format
        Object.entries(user.prices || {}).forEach(([k, v]) => {
            if (k.includes(' > ')) {
                const [main, sub] = k.split(' > ');
                addPriceRow(main, sub, v);
            } else {
                addPriceRow('ì•„ì´í…œ ì œì‘', '', v); // Fallback
            }
        });

        async function handleSave(e) {
            e.preventDefault();

            const prices = {};
            const rows = document.getElementById('price-container').children;
            for (let row of rows) {
                const main = row.querySelector('.main-cat').value;
                const subSelect = row.querySelector('.sub-cat');
                const sub = subSelect.value;
                const value = row.querySelector('input[type="text"]').value;

                const key = sub ? `${main} > ${sub}` : main;
                if (value) prices[key] = value;
            }

            const data = {
                id: user.id,
                name: document.getElementById('name').value,
                role: document.getElementById('role').value,
                zepeto_id: document.getElementById('zepeto_id').value,
                description: document.getElementById('description').value,
                prices: prices
            };

            try {
                const res = await fetch('/api/crew/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionStorage.getItem('crew_token')
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    // Update session storage with new values so they persist if user comes back
                    user.name = data.name;
                    user.role = data.role;
                    user.zepeto_id = data.zepeto_id;
                    user.description = data.description;
                    user.prices = data.prices;
                    sessionStorage.setItem('crew_user', JSON.stringify(user));

                    alert('âœ… ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤! ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    window.location.href = 'cauchemar.html';
                } else {
                    alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }
            } catch (err) {
                alert('ì„œë²„ ì˜¤ë¥˜');
            }
        }

        function logout() {
            sessionStorage.removeItem('crew_user');
            window.location.href = 'login.html';
        }
    </script>
    <!-- Agreement Modal -->
    <div id="agreement-modal"
        class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div
            class="bg-[#1a1a1a] border border-white/10 rounded-2xl w-full max-w-lg p-6 shadow-2xl transform transition-all scale-100">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <span class="text-purple-500">ğŸ“œ</span> ìˆ˜ìµ ë¶„ë°° ë° ì •ì‚° ë™ì˜ì„œ
            </h3>
            <div
                class="bg-black/30 rounded-xl p-4 h-64 overflow-y-auto text-xs text-gray-300 leading-relaxed space-y-3 mb-6 border border-white/5">
                <p><strong class="text-white">1. ìˆ˜ìµ ë°°ë¶„:</strong> í¬ë¦¬ì—ì´í„°(ê·€í•˜)ê°€ ì œì‘í•œ ì•„ì´í…œ ë° ì½˜í…ì¸ ë¡œ ë°œìƒí•œ ìˆœìˆ˜ìµì˜ <strong>80%ëŠ” ê·€í•˜ì—ê²Œ,
                        20%ëŠ” Cauchemar Agencyì—ê²Œ</strong> ê·€ì†ë©ë‹ˆë‹¤.</p>
                <p><strong class="text-white">2. ì •ì‚° ì¼ì •:</strong> ì •ì‚°ì€ <strong>ë§¤ì›” 15ì¼</strong>ì— ì§„í–‰ë©ë‹ˆë‹¤. ë‹¨, ì œí˜í†  ë³¸ì‚¬ì˜ ì •ì±…ì´ë‚˜
                    ì—ì´ì „ì‹œ ë²•ì¸ ê³„ì¢Œì˜ ì´ì²´ í•œë„ ì œí•œì´ ë°œìƒí•  ê²½ìš°, <strong>í•œë„ê°€ í•´ì œë˜ëŠ” ë‹¹ì¼ ë˜ëŠ” ìµì¼</strong>ì— ì¦‰ì‹œ ì§€ê¸‰ë©ë‹ˆë‹¤.</p>
                <p><strong class="text-white">3. ê¶Œë¦¬ ë° ì˜ë¬´:</strong> ê·€í•˜ëŠ” ë³¸ ë™ì˜ì— ì„œëª…í•˜ì§€ ì•Šì„ ê²½ìš°, Cauchemar Crewì˜ ì¼ì›ìœ¼ë¡œì„œ ì•„ì´í…œ ì—…ë¡œë“œ ë°
                    í¬íŠ¸í´ë¦¬ì˜¤ ë“±ë¡ í™œë™ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <p><strong class="text-white">4. ì„¸ê¸ˆ:</strong> ê´€ë ¨ ë²•ë ¹ì— ë”°ë¼ 3.3%ì˜ ì‚¬ì—…ì†Œë“ì„¸ê°€ ì›ì²œì§•ìˆ˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <p><strong class="text-white">5. ìœ íš¨ ê¸°ê°„:</strong> ë³¸ ë™ì˜ëŠ” í¬ë£¨ íƒˆí‡´ ì‹œê¹Œì§€ ìœ íš¨í•©ë‹ˆë‹¤.</p>
            </div>
            <div class="flex items-center gap-3 mb-6 bg-purple-500/5 p-3 rounded-lg border border-purple-500/10">
                <input type="checkbox" id="modal-agree-chk" class="w-5 h-5 accent-purple-500 cursor-pointer rounded">
                <label for="modal-agree-chk" class="text-xs text-gray-200 select-none cursor-pointer">ìœ„ ì •ì‚° ë‚´ìš©ì— ë™ì˜í•˜ë©°, ì´ë¥¼
                    ì¤€ìˆ˜í•˜ê² ìŠµë‹ˆë‹¤.</label>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closeAgreementModal()"
                    class="flex-1 py-3 rounded-xl text-gray-400 hover:bg-white/5 transition font-bold text-sm">ë‹«ê¸°</button>
                <button type="button" onclick="confirmAgreement()"
                    class="flex-1 py-3 rounded-xl bg-white text-black hover:bg-purple-100 transition font-black text-sm uppercase tracking-tighter">ë™ì˜
                    ë° ì„œëª…í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // Check Agreement Status
        if (!user.agreed_to_terms) {
            // Disable Pricing Section
            const priceSection = document.getElementById('price-container');
            priceSection.classList.add('opacity-30', 'pointer-events-none', 'grayscale');

            // Hide Add Button & Show Banner
            document.getElementById('add-price-btn').classList.add('hidden');
            document.getElementById('agreement-banner').classList.remove('hidden');
        }

        function openAgreementModal() {
            document.getElementById('agreement-modal').classList.remove('hidden');
        }

        function closeAgreementModal() {
            document.getElementById('agreement-modal').classList.add('hidden');
        }

        async function confirmAgreement() {
            const chk = document.getElementById('modal-agree-chk');
            if (!chk.checked) {
                alert('ë™ì˜ í•­ëª©ì— ì²´í¬í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const res = await fetch('/api/crew/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionStorage.getItem('crew_token')
                    },
                    body: JSON.stringify({
                        id: user.id,
                        agreed_to_terms: true
                    })
                });

                if (res.ok) {
                    alert('âœ… ì •ì‚° ë™ì˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    user.agreed_to_terms = true;
                    sessionStorage.setItem('crew_user', JSON.stringify(user));
                    window.location.reload();
                } else {
                    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (err) {
                alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜');
            }
        }
    </script>
</body>

</html>